<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отчет по Контрагентам</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding-bottom: 50px; font-size: 0.9em; }
        .container { width: 100%; max-width: 100vw; margin: 0; padding: 0 0 50px 0; overflow-x: hidden; }
        /* Панель фильтрации */
        .filter-panel {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
            justify-content: center;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 18px;
            margin-bottom: 18px;
            box-sizing: border-box;
        }
        .filter-panel label { margin-bottom: 0; font-weight: 500; }
        .filter-panel input[type="date"] {
            min-width: 120px;
            padding: 4px 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .filter-panel input[type="search"] {
            min-width: 200px;
            flex: 1 1 200px;
            padding: 4px 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .filter-panel button {
            padding: 4px 14px;
            font-size: 1em;
            border: 1px solid #bbb;
            border-radius: 4px;
            background: #f3f3f3;
            cursor: pointer;
            transition: background 0.2s;
        }
        .filter-panel button:hover { background: #e0e0e0; }
        /* Таблица */
        table.dataTable {
            width: 100% !important;
            margin-bottom: 1rem !important;
            border-collapse: collapse !important;
            border: 1px solid #e0e0e0;
            table-layout: auto;
        }
        table.dataTable th, table.dataTable td {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            text-align: left;
            vertical-align: middle;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            background: #fff;
        }
        /* Контрагент и счет — не рвутся, но ограничены по ширине, с троеточием */
        table.dataTable td:nth-child(2), table.dataTable th:nth-child(2),
        table.dataTable td:nth-child(4), table.dataTable th:nth-child(4) {
            max-width: 180px;
            white-space: nowrap;
            word-break: keep-all;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Последняя колонка (Назначение) — переносится, занимает максимум */
        table.dataTable th:last-child, table.dataTable td:last-child {
            min-width: 200px;
            max-width: 600px;
            width: auto;
            white-space: normal !important;
            word-break: break-word;
            text-align: left !important;
        }
        /* Дата, Тип, Организация — всегда в одну строку, не обрываются */
        table.dataTable td:nth-child(1), table.dataTable th:nth-child(1),
        table.dataTable td:nth-child(3), table.dataTable th:nth-child(3) {
            min-width: 80px;
            max-width: 180px;
            white-space: nowrap;
            word-break: keep-all;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        table.dataTable th { background-color: #f5f5f5; border-bottom: 2px solid #bdbdbd; font-weight: 600; white-space: nowrap; }
        table.dataTable td:nth-child(n+5) { text-align: right; font-family: monospace; white-space: nowrap; }
        table.dataTable tbody tr:hover { background-color: #f3f6fa; }
        table.dataTable tbody tr:nth-child(even) { background: #f8f9fb; }
        table.dataTable tbody tr { border-bottom: 1.5px solid #e0e0e0; transition: background 0.15s; cursor: pointer; }
        /* Child-таблица операций */
        .child-table-container { padding: 10px 15px 10px 40px; background-color: #f9f9f9; border-top: 1px solid #ddd; }
        .child-table { width: 100%; border-collapse: collapse; margin-top: 5px; table-layout: auto; }
        .child-table th, .child-table td {
            padding: 8px 10px;
            border: 1px solid #e8e8e8;
            font-size: 0.95em;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            background: #fff;
        }
        .child-table th:last-child, .child-table td:last-child {
            min-width: 200px;
            max-width: 600px;
            width: auto;
            white-space: normal !important;
            word-break: break-word;
            text-align: left !important;
        }
        /* Контрагент и счет во внутренней таблице */
        .child-table td:nth-child(1), .child-table th:nth-child(1),
        .child-table td:nth-child(5), .child-table th:nth-child(5) {
            max-width: 180px;
            white-space: nowrap;
            word-break: keep-all;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* child-table: Дата, Тип, Организация */
        .child-table td:nth-child(2), .child-table th:nth-child(2),
        .child-table td:nth-child(4), .child-table th:nth-child(4) {
            min-width: 80px;
            max-width: 180px;
            white-space: nowrap;
            word-break: keep-all;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .child-org-row td:first-child { padding-left: 25px !important; font-style: italic; }
        .income { color: #388e3c; }
        .expense { color: #d32f2f; }
        .no-data { font-style: italic; color: #757575; }
        .cp-name-display { font-weight: bold; }
        /* Скрыть стандартный поиск DataTables */
        div.dataTables_filter { display: none !important; }
        /* DataTables кнопки */
        .dt-buttons { float: right; margin-bottom: 10px; }
        .dt-button { background: #f3f3f3; border: 1px solid #bbb; border-radius: 4px; padding: 4px 12px; margin-left: 6px; font-size: 1em; cursor: pointer; transition: background 0.2s; }
        .dt-button:hover { background: #e0e0e0; }
        
        /* Панель статистики */
        .stats-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 18px;
            box-sizing: border-box;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }
        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            font-family: monospace;
        }
        .stat-value.income { color: #388e3c; }
        .stat-value.expense { color: #d32f2f; }
        
        /* Индикаторы фильтров */
        .filter-indicators {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: 10px;
        }
        .filter-indicator {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            border: 1px solid #bbdefb;
        }
        .filter-indicator.active {
            background: #1976d2;
            color: white;
        }
        
        /* Секция графиков */
        .charts-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 18px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .chart-container h3 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            color: #333;
        }
        .chart-container canvas {
            max-width: 100%;
            height: auto;
        }
        
        /* Улучшенные фильтры */
        .filter-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .filter-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .filter-row label {
            font-weight: 500;
            min-width: 80px;
        }
        .filter-row input[type="number"] {
            width: 100px;
            padding: 4px 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* Чекбоксы организаций */
        .org-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-left: 10px;
        }
        .org-checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
            cursor: pointer;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
            transition: background 0.2s;
        }
        .org-checkbox-label:hover {
            background: #e9e9e9;
        }
        .org-checkbox-label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.1);
        }
        
        
    </style>
</head>
<body>
<main class="container">
    <h1>Отчет по Контрагентам <small>(с детализацией)</small></h1>
    <p>Дата формирования: {{ generation_time }}</p>
    <p>Проанализированы организации: {{ analyzed_org_names | join(', ') }}</p>
    
    <!-- Быстрая статистика -->
    <div class="stats-panel" id="statsPanel">
        <div class="stat-item">
            <span class="stat-label">Контрагентов:</span>
            <span class="stat-value" id="totalCounterparties">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Общий приход:</span>
            <span class="stat-value income" id="totalIncome">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Общий расход:</span>
            <span class="stat-value expense" id="totalExpense">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Сальдо:</span>
            <span class="stat-value" id="totalBalance">-</span>
        </div>
    </div>
    
    <!-- Секция графиков -->
    <div class="charts-section" id="chartsSection">
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Тренды по месяцам</h3>
                <canvas id="trendsChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
                <h3>Распределение по ОПФ</h3>
                <canvas id="legalFormsChart" width="300" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h3>Топ-10 контрагентов</h3>
                <canvas id="topCounterpartiesChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="filter-panel" id="filterPanel">
        <div class="filter-row">
            <label for="dateFrom">Период:</label>
            <input type="date" id="dateFrom">
            <span>—</span>
            <input type="date" id="dateTo">
        </div>
        <div class="filter-row">
            <label for="tableSearch">Поиск:</label>
            <input type="search" id="tableSearch" placeholder="Поиск по контрагентам, ИНН..." style="flex: 1; min-width: 300px; font-size: 1.1em; padding: 8px 12px;">
        </div>
        <div class="filter-row">
            <label>Наши организации:</label>
            <div class="org-checkboxes" id="orgCheckboxes">
                {% for org_name in analyzed_org_names %}
                <label class="org-checkbox-label">
                    <input type="checkbox" class="org-checkbox" value="{{ org_name | e }}" checked>
                    {{ org_name }}
                </label>
                {% endfor %}
            </div>
        </div>
        <div class="filter-row">
            <label for="minAmount">Сумма операций от:</label>
            <input type="number" id="minAmount" placeholder="0" step="0.01" title="Минимальная общая сумма операций с контрагентом">
            <label for="maxAmount">до:</label>
            <input type="number" id="maxAmount" placeholder="∞" step="0.01" title="Максимальная общая сумма операций с контрагентом">
        </div>
        <div class="filter-row">
            <label for="minOperations">Количество операций от:</label>
            <input type="number" id="minOperations" placeholder="0" min="0" title="Минимальное количество операций с контрагентом">
            <label for="maxOperations">до:</label>
            <input type="number" id="maxOperations" placeholder="∞" min="0" title="Максимальное количество операций с контрагентом">
        </div>
        <div class="filter-row">
            <button id="clearFilters" type="button">Сбросить все</button>
            <div class="filter-indicators" id="filterIndicators"></div>
        </div>
    </div>
    <p><i>Кликните на '▶' для просмотра деталей по годам и организациям. Используйте поиск и фильтры.</i></p>

    {% if not report_data_json %}
        <p>Нет данных о транзакциях с контрагентами для отображения.</p>
    {% else %}
        <table id="annualReportTable" class="display compact" style="width:100%">
            <thead>
                <tr>
                    <th></th> <!-- Для +/- контроля -->
                    <th>Контрагент</th>
                    <th>ИНН</th>
                    <th>Счет</th>
                    <th>Приход (Итого)</th>
                    <th>Расход (Итого)</th>
                </tr>
            </thead>
            <tbody></tbody> {# Данные будут загружены через JS #}
        </table>
    {% endif %}
</main>

<!-- Вставляем данные в JSON формате для JavaScript -->
<script type="application/json" id="reportData">
{{ report_data_json | safe }}
</script>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script>
    // Функция форматирования дочерней строки
    function formatChildRow ( rowData ) {
        if (!rowData.years_details || rowData.years_details.length === 0) {
            return '<div class="child-table-container no-data">Нет деталей для отображения.</div>';
        }
        let childHtml = '<div class="child-table-container"><table class="child-table"><thead><tr><th>Год / Организация</th><th>Приход</th><th>Расход</th></tr></thead><tbody>';
        rowData.years_details.forEach(yearDetail => {
            // Строка с итогами по году
            childHtml += `<tr style="font-weight:bold; background-color:#eee;"><td>${yearDetail.year} год</td><td>${formatCurrency(yearDetail.year_income)}</td><td>${formatCurrency(yearDetail.year_expense)}</td></tr>`;
            // Строки с детализацией по организациям в этом году
            yearDetail.orgs.forEach(orgDetail => {
                childHtml += `<tr class="child-org-row"><td>${escapeHtml(orgDetail.name)}</td><td>${formatCurrency(orgDetail.income)}</td><td>${formatCurrency(orgDetail.expense)}</td></tr>`;
            });
         });
        childHtml += '</tbody></table></div>';
        return childHtml;
     }

    // Функция форматирования валюты
    function formatCurrency(amount) {
        if (amount == null || isNaN(amount)) return '0,00';
        // Используем toLocaleString для правильного форматирования с разделителями
        return amount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Функция экранирования HTML для безопасного вывода
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') {
            return unsafe === null || unsafe === undefined ? "" : String(unsafe);
        }
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(unsafe));
        return div.innerHTML;
     }

    // Функция форматирования имени для отображения в таблице
    function formatDisplayName(nameNormalized, legalForm, displayNameHint, rawNames) {
        // Приоритет у display_name, если он был сформирован на бэкенде (Фамилия И.О.)
        if (displayNameHint) {
            if (legalForm === 'ИП') return `ИП ${displayNameHint}`;
            return displayNameHint; // Для ФЛ без префикса
        }

        // Иначе форматируем по стандартным правилам, используя name_normalized
        if (!nameNormalized || nameNormalized === "?") return `<span title="${escapeHtml(rawNames)}">?</span>`;
        let escapedName = escapeHtml(nameNormalized);

        if (legalForm === 'ИП') return `<span title="${escapeHtml(rawNames)}">ИП ${escapedName}</span>`; // Имя уже должно быть ФИО
        if (legalForm === 'ООО') return `<span title="${escapeHtml(rawNames)}">ООО "${escapedName}"</span>`;
        if (legalForm === 'АО') return `<span title="${escapeHtml(rawNames)}">АО "${escapedName}"</span>`;
        if (legalForm === 'ГОС') return `<span title="${escapeHtml(rawNames)}">${escapedName}</span>`;
        if (legalForm === 'ФЛ' || legalForm === 'ИП/ФЛ') return `<span title="${escapeHtml(rawNames)}">${escapedName}</span>`; // Уже должно быть ФИО

        // Для остальных ОПФ (АНО, ФОНД и т.д.) и ДРУГОЕ/ЮЛ
        if (legalForm && legalForm !== 'ДРУГОЕ' && legalForm !== 'ЮЛ') {
             // Простая эвристика: если в имени есть пробел, считаем ФИО или сложным названием - без кавычек
             let isLikelyFioOrComplex = escapedName.includes(' ');
             return isLikelyFioOrComplex
                    ? `<span title="${escapeHtml(rawNames)}">${legalForm} ${escapedName}</span>`
                    : `<span title="${escapeHtml(rawNames)}">${legalForm} "${escapedName}"</span>`;
        }
        // Просто имя для ДРУГОЕ/ЮЛ
        return `<span title="${escapeHtml(rawNames)}">${escapedName}</span>`;
    }

    // Фильтрация по периоду
    function isOpInPeriod(op, from, to) {
        if (!op.date) return false;
        if (from && op.date < from) return false;
        if (to && op.date > to) return false;
        return true;
    }
    
    // Обновление статистики
    function updateStats() {
        if (typeof window.table === 'undefined' || typeof window.tableData === 'undefined') {
            return;
        }
        
        let {from, to} = getPeriod();
        let searchText = $('#tableSearch').val().toLowerCase();
        let selectedOrgs = getSelectedOrgs();
        
        let totalIncome = 0, totalExpense = 0, visibleCount = 0;
        
        // Проходим по всем данным
        window.tableData.forEach(function(rowData) {
            // Проверяем поиск
            let matchesSearch = true;
            if (searchText) {
                let name = (rowData.name_normalized || '').toLowerCase();
                let inn = (rowData.inn || '').toLowerCase();
                matchesSearch = name.includes(searchText) || inn.includes(searchText);
            }
            
            if (!matchesSearch) return;
            
            // Проверяем, есть ли операции в выбранном периоде и выбранных организациях
            let hasOpsInPeriod = false;
            let periodIncome = 0, periodExpense = 0;
            
            (rowData.years_details || []).forEach(y => {
                // Проверяем, есть ли операции от выбранных организаций
                let hasSelectedOrg = false;
                y.orgs.forEach(org => {
                    if (selectedOrgs.includes(org.name)) {
                        hasSelectedOrg = true;
                    }
                });
                
                if (hasSelectedOrg) {
                    (y.operations || []).forEach(op => {
                        if (isOpInPeriod(op, from, to)) {
                            hasOpsInPeriod = true;
                            
                            if (op.type === 'income') {
                                periodIncome += op.amount || 0;
                            } else {
                                periodExpense += op.amount || 0;
                            }
                        }
                    });
                }
            });
            
            if (hasOpsInPeriod) {
                visibleCount++;
                totalIncome += periodIncome;
                totalExpense += periodExpense;
            }
        });
        
        $('#totalCounterparties').text(visibleCount);
        $('#totalIncome').text(formatCurrency(totalIncome));
        $('#totalExpense').text(formatCurrency(totalExpense));
        
        let balance = totalIncome - totalExpense;
        $('#totalBalance').text(formatCurrency(balance));
        $('#totalBalance').removeClass('income expense');
        if (balance > 0) $('#totalBalance').addClass('income');
        else if (balance < 0) $('#totalBalance').addClass('expense');
    }
    
    // Получение периода фильтрации
    function getPeriod() {
        let from = $('#dateFrom').val();
        let to = $('#dateTo').val();
        return {from, to};
    }
    
    // Обновление индикаторов фильтров
    function updateFilterIndicators() {
        let indicators = $('#filterIndicators');
        indicators.empty();
        
        let {from, to} = getPeriod();
        let searchText = $('#tableSearch').val();
        let minAmount = $('#minAmount').val();
        let maxAmount = $('#maxAmount').val();
        let minOps = $('#minOperations').val();
        let maxOps = $('#maxOperations').val();
        let selectedOrgs = getSelectedOrgs();
        
        if (from || to) {
            let periodText = '';
            if (from && to) periodText = `${from} — ${to}`;
            else if (from) periodText = `с ${from}`;
            else if (to) periodText = `до ${to}`;
            indicators.append(`<span class="filter-indicator active">Период: ${periodText}</span>`);
        }
        
        if (searchText) {
            indicators.append(`<span class="filter-indicator active">Поиск: "${searchText}"</span>`);
        }
        
        if (minAmount || maxAmount) {
            let amountText = '';
            if (minAmount && maxAmount) amountText = `${minAmount} — ${maxAmount}`;
            else if (minAmount) amountText = `от ${minAmount}`;
            else if (maxAmount) amountText = `до ${maxAmount}`;
            indicators.append(`<span class="filter-indicator active">Сумма: ${amountText}</span>`);
        }
        
        if (minOps || maxOps) {
            let opsText = '';
            if (minOps && maxOps) opsText = `${minOps} — ${maxOps}`;
            else if (minOps) opsText = `от ${minOps}`;
            else if (maxOps) opsText = `до ${maxOps}`;
            indicators.append(`<span class="filter-indicator active">Операций: ${opsText}</span>`);
        }
        
        if (selectedOrgs.length < $('.org-checkbox').length) {
            indicators.append(`<span class="filter-indicator active">Организации: ${selectedOrgs.length} из ${$('.org-checkbox').length}</span>`);
        }
    }

    // Переопределяем child-row: теперь показываем таблицу операций
    function formatChildRow(rowData, dateFrom, dateTo) {
        if (!rowData.years_details || rowData.years_details.length === 0) {
            return '<div class="child-table-container no-data">Нет деталей для отображения.</div>';
        }
        let childHtml = '';
        rowData.years_details.forEach(yearDetail => {
            // Фильтруем операции по периоду
            let ops = yearDetail.operations || [];
            if (dateFrom || dateTo) {
                ops = ops.filter(op => isOpInPeriod(op, dateFrom, dateTo));
            }
            if (ops.length === 0) return; // Нет операций в этом году

            childHtml += `<div class="child-table-container"><b>${yearDetail.year} год</b>`;
            childHtml += `<table class="child-table"><thead>
                <tr>
                    <th>Дата</th>
                    <th>Тип</th>
                    <th>Сумма</th>
                    <th>Организация</th>
                    <th>Счет</th>
                    <th>№</th>
                    <th>Назначение</th>
                </tr>
            </thead><tbody>`;
            ops.forEach(op => {
                childHtml += `<tr>
                    <td>${escapeHtml(op.date)}</td>
                    <td>${op.type === 'income' ? 'Приход' : 'Расход'}</td>
                    <td style="text-align:right;">${formatCurrency(op.amount)}</td>
                    <td>${escapeHtml(op.org)}</td>
                    <td>${escapeHtml(op.account)}</td>
                    <td>${escapeHtml(op.doc_number)}</td>
                    <td>${escapeHtml(op.purpose)}</td>
                </tr>`;
            });
            childHtml += '</tbody></table></div>';
        });
        if (!childHtml) {
            return '<div class="child-table-container no-data">Нет операций за выбранный период.</div>';
        }
        return childHtml;
    }

    // Переменные для графиков
    // Инициализируем переменные графиков в глобальной области
    window.trendsChart = null;
    window.legalFormsChart = null;
    window.topCounterpartiesChart = null;
    
    
    // Создание графика трендов
    function createTrendsChart() {
        try {
            const canvas = document.getElementById('trendsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
        
        // Получаем текущие фильтры
        const {from, to} = getPeriod();
        const searchText = $('#tableSearch').val().toLowerCase();
        const selectedOrgs = getSelectedOrgs();
        
        // Собираем данные по месяцам с учетом фильтров
        const monthlyData = {};
        window.tableData.forEach(cp => {
            // Проверяем поиск
            let matchesSearch = true;
            if (searchText) {
                let name = (cp.name_normalized || '').toLowerCase();
                let inn = (cp.inn || '').toLowerCase();
                matchesSearch = name.includes(searchText) || inn.includes(searchText);
            }
            
            if (!matchesSearch) return;
            
            (cp.years_details || []).forEach(y => {
                // Проверяем, есть ли операции от выбранных организаций
                let hasSelectedOrg = false;
                y.orgs.forEach(org => {
                    if (selectedOrgs.includes(org.name)) {
                        hasSelectedOrg = true;
                    }
                });
                
                if (hasSelectedOrg) {
                    (y.operations || []).forEach(op => {
                        if (isOpInPeriod(op, from, to)) {
                            const month = op.date.substring(0, 7); // YYYY-MM
                            if (!monthlyData[month]) {
                                monthlyData[month] = { income: 0, expense: 0 };
                            }
                            if (op.type === 'income') {
                                monthlyData[month].income += op.amount || 0;
                            } else {
                                monthlyData[month].expense += op.amount || 0;
                            }
                        }
                    });
                }
            });
        });
        
        const months = Object.keys(monthlyData).sort();
        const incomeData = months.map(m => monthlyData[m].income);
        const expenseData = months.map(m => monthlyData[m].expense);
        
        if (window.trendsChart && typeof window.trendsChart.destroy === 'function') {
            window.trendsChart.destroy();
        }
        
        window.trendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Приход',
                    data: incomeData,
                    borderColor: '#388e3c',
                    backgroundColor: 'rgba(56, 142, 60, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Расход',
                    data: expenseData,
                    borderColor: '#d32f2f',
                    backgroundColor: 'rgba(211, 47, 47, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
        } catch (error) {
            console.error('Ошибка при создании графика трендов:', error);
        }
    }
    
    // Создание круговой диаграммы по ОПФ
    function createLegalFormsChart() {
        try {
            const canvas = document.getElementById('legalFormsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
        
        // Получаем текущие фильтры
        const {from, to} = getPeriod();
        const searchText = $('#tableSearch').val().toLowerCase();
        const selectedOrgs = getSelectedOrgs();
        
        const legalFormsData = {};
        window.tableData.forEach(cp => {
            // Проверяем поиск
            let matchesSearch = true;
            if (searchText) {
                let name = (cp.name_normalized || '').toLowerCase();
                let inn = (cp.inn || '').toLowerCase();
                matchesSearch = name.includes(searchText) || inn.includes(searchText);
            }
            
            if (!matchesSearch) return;
            
            // Проверяем, есть ли операции от выбранных организаций
            let hasSelectedOrg = false;
            let hasNonInternalOps = false;
            
            (cp.years_details || []).forEach(y => {
                y.orgs.forEach(org => {
                    if (selectedOrgs.includes(org.name)) {
                        hasSelectedOrg = true;
                    }
                });
                
                if (hasSelectedOrg) {
                    (y.operations || []).forEach(op => {
                        if (isOpInPeriod(op, from, to)) {
                            hasNonInternalOps = true;
                        }
                    });
                }
            });
            
            if (hasSelectedOrg && hasNonInternalOps) {
                const form = cp.legal_form || 'ДРУГОЕ';
                if (!legalFormsData[form]) {
                    legalFormsData[form] = 0;
                }
                legalFormsData[form]++;
            }
        });
        
        const labels = Object.keys(legalFormsData);
        const data = Object.values(legalFormsData);
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
        ];
        
        if (window.legalFormsChart && typeof window.legalFormsChart.destroy === 'function') {
            window.legalFormsChart.destroy();
        }
        
        window.legalFormsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
        } catch (error) {
            console.error('Ошибка при создании круговой диаграммы:', error);
        }
    }
    
    // Создание графика топ-10 контрагентов
    function createTopCounterpartiesChart() {
        try {
            const canvas = document.getElementById('topCounterpartiesChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
        
        // Получаем текущие фильтры
        const {from, to} = getPeriod();
        const searchText = $('#tableSearch').val().toLowerCase();
        const selectedOrgs = getSelectedOrgs();
        
        // Сортируем контрагентов по общему объему операций с учетом фильтров
        const filteredCounterparties = window.tableData
            .map(cp => {
                // Проверяем поиск
                let matchesSearch = true;
                if (searchText) {
                    let name = (cp.name_normalized || '').toLowerCase();
                    let inn = (cp.inn || '').toLowerCase();
                    matchesSearch = name.includes(searchText) || inn.includes(searchText);
                }
                
                if (!matchesSearch) return null;
                
                // Считаем сумму операций с учетом фильтров
                let totalAmount = 0;
                let hasSelectedOrg = false;
                
                (cp.years_details || []).forEach(y => {
                    y.orgs.forEach(org => {
                        if (selectedOrgs.includes(org.name)) {
                            hasSelectedOrg = true;
                        }
                    });
                    
                    if (hasSelectedOrg) {
                        (y.operations || []).forEach(op => {
                            if (isOpInPeriod(op, from, to)) {
                                totalAmount += op.amount || 0;
                            }
                        });
                    }
                });
                
                return hasSelectedOrg && totalAmount > 0 ? {
                    name: cp.name_normalized || 'Неизвестно',
                    total: totalAmount
                } : null;
            })
            .filter(cp => cp !== null)
            .sort((a, b) => b.total - a.total)
            .slice(0, 10);
        
        const labels = filteredCounterparties.map(cp => cp.name.length > 20 ? cp.name.substring(0, 20) + '...' : cp.name);
        const data = filteredCounterparties.map(cp => cp.total);
        
        if (window.topCounterpartiesChart && typeof window.topCounterpartiesChart.destroy === 'function') {
            window.topCounterpartiesChart.destroy();
        }
        
        window.topCounterpartiesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Общий объем операций',
                    data: data,
                    backgroundColor: '#36A2EB',
                    borderColor: '#36A2EB',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
        } catch (error) {
            console.error('Ошибка при создании графика топ-10 контрагентов:', error);
        }
    }
    
    // Сохранение состояния фильтров
    function saveFilterState() {
        const selectedOrgs = getSelectedOrgs();
        const state = {
            dateFrom: $('#dateFrom').val(),
            dateTo: $('#dateTo').val(),
            search: $('#tableSearch').val(),
            minAmount: $('#minAmount').val(),
            maxAmount: $('#maxAmount').val(),
            minOperations: $('#minOperations').val(),
            maxOperations: $('#maxOperations').val(),
            selectedOrgs: selectedOrgs
        };
        localStorage.setItem('annualReportFilters', JSON.stringify(state));
        
        // Сохраняем в URL
        const params = new URLSearchParams();
        Object.entries(state).forEach(([key, value]) => {
            if (value && value !== false) {
                if (Array.isArray(value)) {
                    params.set(key, value.join(','));
                } else {
                    params.set(key, value);
                }
            }
        });
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.history.replaceState({}, '', newUrl);
    }
    
    function loadFilterState() {
        // Сначала пробуем загрузить из URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlState = {};
        ['dateFrom', 'dateTo', 'search', 'minAmount', 'maxAmount', 'minOperations', 'maxOperations', 'selectedOrgs'].forEach(key => {
            const value = urlParams.get(key);
            if (value) urlState[key] = value;
        });
        
        // Если в URL есть параметры, используем их
        if (Object.keys(urlState).length > 0) {
            Object.entries(urlState).forEach(([key, value]) => {
                if (key === 'selectedOrgs') {
                    const orgs = value.split(',');
                    $('.org-checkbox').prop('checked', false);
                    orgs.forEach(org => {
                        $(`.org-checkbox[value="${org}"]`).prop('checked', true);
                    });
                } else {
                    $(`#${key}`).val(value);
                }
            });
        } else {
            // Иначе загружаем из localStorage
            const saved = localStorage.getItem('annualReportFilters');
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    Object.entries(state).forEach(([key, value]) => {
                        if (key === 'selectedOrgs') {
                            const orgs = Array.isArray(value) ? value : [value];
                            $('.org-checkbox').prop('checked', false);
                            orgs.forEach(org => {
                                $(`.org-checkbox[value="${org}"]`).prop('checked', true);
                            });
                        } else if (value) {
                            $(`#${key}`).val(value);
                        }
                    });
                } catch (e) {
                    console.warn('Ошибка загрузки состояния фильтров:', e);
                }
            }
        }
    }
    
    // Получение списка выбранных организаций
    function getSelectedOrgs() {
        const selectedOrgs = [];
        $('.org-checkbox:checked').each(function() {
            selectedOrgs.push($(this).val());
        });
        return selectedOrgs;
    }
    
    
    // Расширенная фильтрация
    function applyAdvancedFilters() {
        if (typeof window.table === 'undefined') return;
        
        const minAmount = parseFloat($('#minAmount').val()) || 0;
        const maxAmount = parseFloat($('#maxAmount').val()) || Infinity;
        const minOps = parseInt($('#minOperations').val()) || 0;
        const maxOps = parseInt($('#maxOperations').val()) || Infinity;
        const selectedOrgs = getSelectedOrgs();
        
        window.table.rows().every(function() {
            const rowData = this.data();
            let shouldShow = true;
            
            // Фильтр по выбранным организациям
            let hasSelectedOrg = false;
            (rowData.years_details || []).forEach(y => {
                y.orgs.forEach(org => {
                    if (selectedOrgs.includes(org.name)) {
                        hasSelectedOrg = true;
                    }
                });
            });
            if (!hasSelectedOrg) {
                shouldShow = false;
            }
            
            // Фильтр по сумме операций
            const totalAmount = (rowData.total_income || 0) + (rowData.total_expense || 0);
            if (totalAmount < minAmount || totalAmount > maxAmount) {
                shouldShow = false;
            }
            
            // Фильтр по количеству операций
            let totalOps = 0;
            
            (rowData.years_details || []).forEach(y => {
                totalOps += (y.operations || []).length;
            });
            
            if (totalOps < minOps || totalOps > maxOps) {
                shouldShow = false;
            }
            
            if (shouldShow) {
                $(this.node()).show();
            } else {
                $(this.node()).hide();
            }
        });
    }

    $(document).ready(function() {
         // Инициализация состояния
         loadFilterState();
         
         // Поддержка сортировки чисел с запятой и пробелами
         jQuery.extend(jQuery.fn.dataTableExt.oSort, {
            "numeric-comma-pre": function ( a ) {
                // Убираем всё кроме цифр, запятой, минуса; меняем запятую на точку
                var x = String(a).replace(/[^\d,-]/g, '').replace(',', '.');
                return parseFloat(x) || 0; // Возвращаем 0, если не число
             },
            "numeric-comma-asc": function ( a, b ) { return a - b; },
            "numeric-comma-desc": function ( a, b ) { return b - a; }
         });

        // Объявляем переменную в глобальной области видимости
        window.tableData = null;
        try {
            // Парсим JSON данные из <script> тега
            window.tableData = JSON.parse(document.getElementById('reportData').textContent);
        }
        catch (e) {
            console.error("Ошибка парсинга JSON данных:", e);
            alert("Ошибка загрузки данных отчета.");
            return; // Прекращаем выполнение, если данные не загружены
        }

        // --- ПЕРИОД: вычисляем min/max даты по всем операциям ---
        let allOps = [];
        window.tableData.forEach(cp => {
            (cp.years_details || []).forEach(y => {
                (y.operations || []).forEach(op => allOps.push(op));
            });
        });
        let minDate = allOps.length ? allOps.map(op => op.date).sort()[0] : null;
        let maxDate = allOps.length ? allOps.map(op => op.date).sort().reverse()[0] : null;
        if (minDate) $('#dateFrom').val(minDate);
        if (maxDate) $('#dateTo').val(maxDate);

        // --- Фильтрация по периоду ---

        // --- Фильтрация строк таблицы по периоду ---
        function filterTableByPeriod() {
            let {from, to} = getPeriod();
            window.table.rows().every(function() {
                let row = this.data();
                // Есть ли хоть одна операция в периоде?
                let hasOps = false;
                (row.years_details || []).forEach(y => {
                    (y.operations || []).forEach(op => {
                        if (isOpInPeriod(op, from, to)) hasOps = true;
                    });
                });
                if (hasOps) {
                    $(this.node()).show();
                } else {
                    $(this.node()).hide();
                }
            });
        }

        // Инициализируем DataTables, только если есть данные
        if (window.tableData && window.tableData.length > 0) {
            window.table = $('#annualReportTable').DataTable({
                data: window.tableData,
                columns: [
                    { // +/- контроль
                        className: 'dt-control',
                        orderable: false,
                        data: null,
                        defaultContent: '',
                        width: '20px' // Фиксируем ширину
                    },
                    { // Контрагент (с форматированием и подсказкой)
                        data: null, // Данные берем из всей строки (row)
                        className: 'cp-name-display',
                        render: function(data, type, row) {
                            // Форматируем имя для отображения
                            return formatDisplayName(row.name_normalized, row.legal_form, row.display_name, row.raw_names);
                        }
                    },
                    { // ИНН
                        data: 'inn',
                        render: function(data) {
                            return data ? escapeHtml(data) : '<span class="no-data">(не указ.)</span>';
                        }
                    },
                    { // Счет (используем список счетов из 'accounts')
                        data: 'accounts',
                        orderable: false, // Обычно не сортируют по счетам
                        render: function(data) {
                            // data здесь - это строка счетов через запятую
                            return data ? escapeHtml(data) : '<span class="no-data">(не указ.)</span>';
                        }
                    },
                    { // Приход
                        data: 'total_income',
                        className: 'income',
                        type: 'numeric-comma', // Тип для сортировки
                        render: function(data) { return formatCurrency(data); } // Форматирование для отображения
                    },
                    { // Расход
                        data: 'total_expense',
                        className: 'expense',
                        type: 'numeric-comma', // Тип для сортировки
                        render: function(data) { return formatCurrency(data); } // Форматирование для отображения
                    }
                 ],
                 // Используем встроенную локализацию
                 "language": {
                     "processing": "Подождите...", "search": "Поиск:", "lengthMenu": "Показать _MENU_ записей",
                     "info": "Записи с _START_ до _END_ из _TOTAL_ записей", "infoEmpty": "Записи с 0 до 0 из 0 записей",
                     "infoFiltered": "(отфильтровано из _MAX_ записей)", "loadingRecords": "Загрузка записей...",
                     "zeroRecords": "Записи отсутствуют.", "emptyTable": "В таблице отсутствуют данные",
                     "paginate": { "first": "Первая", "previous": "Предыдущая", "next": "Следующая", "last": "Последняя" },
                     "aria": { "sortAscending": ": активировать для сортировки столбца по возрастанию", "sortDescending": ": активировать для сортировки столбца по убыванию" }
                 },
                 "paging": false,       // Пагинация ВЫКЛЮЧЕНА
                 "lengthChange": false, // Выбор кол-ва строк убран
                 "info": true,          // Оставили инфо (Показано X из Y записей)
                 "order": [[1, 'asc']], // Сортировка по имени контрагента по умолчанию
                 "searching": true,     // Включаем поиск
                 "columnDefs": [
                    // Применяем тип сортировки к колонкам с суммами
                    { "type": "numeric-comma", "targets": [4, 5] }
                  ],
                  dom: 'Bfrtip',
                  buttons: [
                      { extend: 'copy', text: 'Копировать' },
                      { extend: 'csv', text: 'CSV' },
                      { extend: 'excel', text: 'Excel' },
                      { extend: 'print', text: 'Печать' },
                      { extend: 'colvis', text: 'Колонки' }
                  ],
                  language: {
                      buttons: {
                          copy: 'Копировать',
                          csv: 'CSV',
                          excel: 'Excel',
                          print: 'Печать',
                          colvis: 'Колонки'
                      }
                  }
             });

            window.table.buttons().container().appendTo('#annualReportTable_wrapper .col-md-6:eq(0)');

            // --- Обновляем child-row с учетом периода ---
            $('#annualReportTable tbody').on('click', 'td.dt-control', function () {
                var tr = $(this).closest('tr');
                var row = window.table.row(tr);
                var {from, to} = getPeriod();
                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('dt-hasChild');
                } else {
                    row.child(formatChildRow(row.data(), from, to)).show();
                    tr.addClass('dt-hasChild');
                }
            });

            // --- События фильтра ---
            $('#dateFrom, #dateTo').on('change', function() {
                filterTableByPeriod();
                applyAdvancedFilters();
                updateStats();
                updateFilterIndicators();
                saveFilterState();
                updateCharts();
                // Закрываем все child-rows при смене периода
                $('#annualReportTable tbody tr.dt-hasChild').each(function() {
                    var tr = $(this);
                    var row = window.table.row(tr);
                    row.child.hide();
                    tr.removeClass('dt-hasChild');
                });
            });
            
            // Обработчики для расширенных фильтров
            $('#minAmount, #maxAmount, #minOperations, #maxOperations, #documentType').on('input change', function() {
                applyAdvancedFilters();
                updateStats();
                updateFilterIndicators();
                saveFilterState();
                updateCharts();
            });
            
            $('#clearFilters').on('click', function() {
                // Сброс всех фильтров
                $('#dateFrom').val(minDate);
                $('#dateTo').val(maxDate);
                $('#tableSearch').val('');
                $('#minAmount, #maxAmount, #minOperations, #maxOperations').val('');
                $('.org-checkbox').prop('checked', true);
                window.table.search('').draw();
                filterTableByPeriod();
                applyAdvancedFilters();
                updateStats();
                updateFilterIndicators();
                saveFilterState();
                updateCharts();
                // Закрыть все child-rows
                $('#annualReportTable tbody tr.dt-hasChild').each(function() {
                    var tr = $(this);
                    var row = window.table.row(tr);
                    row.child.hide();
                    tr.removeClass('dt-hasChild');
                });
            });

            // Первичная фильтрация
            filterTableByPeriod();
            
            // Обновляем индикаторы после инициализации таблицы
            updateFilterIndicators();

            // Поиск через наш input
            $('#tableSearch').on('input', function() {
                window.table.search(this.value).draw();
                updateStats();
                updateFilterIndicators();
                saveFilterState();
                updateCharts();
            });
            
            // Обработчики для новых фильтров
            $('.org-checkbox').on('change', function() {
                applyAdvancedFilters();
                updateStats();
                updateFilterIndicators();
                saveFilterState();
                updateCharts();
            });
            
            // Функция обновления всех графиков
            function updateCharts() {
                try {
                    // Уничтожаем существующие графики перед созданием новых
                    if (window.trendsChart && typeof window.trendsChart.destroy === 'function') {
                        window.trendsChart.destroy();
                    }
                    if (window.legalFormsChart && typeof window.legalFormsChart.destroy === 'function') {
                        window.legalFormsChart.destroy();
                    }
                    if (window.topCounterpartiesChart && typeof window.topCounterpartiesChart.destroy === 'function') {
                        window.topCounterpartiesChart.destroy();
                    }
                    
                    createTrendsChart();
                    createLegalFormsChart();
                    createTopCounterpartiesChart();
                } catch (error) {
                    console.error('Ошибка при обновлении графиков:', error);
                }
            }
            
            // Инициализация графиков
            updateCharts();
            
            // Обновляем статистику при изменении таблицы
            window.table.on('draw', function() {
                updateStats();
            });
            
            // Инициализируем статистику сразу после создания таблицы
            setTimeout(function() {
                updateStats();
            }, 200);
        } else {
             // Если данных нет, можно вывести сообщение
             $('#annualReportTable').after('<p>Нет данных для отображения в таблице.</p>');
        }
    });
</script>
</body>
</html>