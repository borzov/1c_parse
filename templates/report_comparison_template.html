<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отчет: Взаимодействие Контрагентов</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@latest/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding-bottom: 50px; font-size: 0.9em; }
        .container { font-size: 0.9em; }
        .container { max-width: 97%; margin: auto; padding: 15px; }
        #filtersContainer { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px 20px; margin-bottom: 1.5em; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px 25px; }
        .filter-group legend { font-weight: bold; margin-bottom: 10px; font-size: 1.05em; display: block; }
        .filter-group label { display: block; margin-bottom: 6px; font-weight: normal; cursor: pointer; }
        .filter-group input[type="checkbox"], .filter-group input[type="radio"] { margin-right: 7px; vertical-align: middle; transform: scale(1.1); }
        .dataTables_wrapper .dataTables_filter input { padding: 0.4em; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        .dataTables_info, .dataTables_filter { margin-bottom: 1em; }
        table.dataTable { width: 100% !important; border-collapse: collapse !important; table-layout: fixed; border: 1px solid #e0e0e0; }
        table.dataTable th, table.dataTable td { border: 1px solid #e0e0e0; padding: 7px 10px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: middle; }
        table.dataTable th:first-child, table.dataTable td:first-child { text-align: left; width: 33%; white-space: normal; vertical-align: top; }
        table.dataTable th { background-color: #f5f5f5; vertical-align: bottom; border-bottom: 2px solid #bdbdbd; font-weight: 600; }
        table.dataTable tbody tr:nth-child(odd) { background-color: #fafafa; }
        table.dataTable tbody tr:hover { background-color: #f0f0f0; }
        .interaction-cell { font-size: 1.7em; font-weight: bold; cursor: default; }
        .income { color: #388e3c; } .expense { color: #d32f2f; } .both { color: #1976d2; }
        .no-data { font-style: italic; color: #757575; }
        .cp-details-small { font-size: 0.85em; color: #424242; display: block; margin-top: 3px; white-space: normal; }
        .legend { line-height: 1.8; margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1rem; }
        .legend span { display: inline-block; width: 1.5em; text-align: center; margin-right: 5px;}
        .cp-name-display { font-weight: bold; }
        
        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            margin: 0;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover { color: #000; }
        .modal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .modal-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .modal-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            font-family: monospace;
        }
        .modal-stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .modal-table th,
        .modal-table td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .modal-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        .modal-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Тепловая карта */
        .heatmap-cell {
            transition: background-color 0.3s ease;
        }
        .heatmap-low { background-color: #e8f5e8; }
        .heatmap-medium { background-color: #c8e6c9; }
        .heatmap-high { background-color: #a5d6a7; }
        .heatmap-very-high { background-color: #81c784; }
        
        /* Секция графиков */
        .charts-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 18px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .chart-container h3 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            color: #333;
        }
        .chart-container canvas {
            max-width: 100%;
            height: auto;
        }
        
    </style>
</head>
<body>
<main class="container">
    <h1>Отчет: Взаимодействие Контрагентов с Организациями</h1>
    <p>Дата формирования: {{ generation_time }}</p>
    
    <!-- Информация -->
    <div style="margin-bottom: 15px;">
        <span style="font-size: 0.9em; color: #666;">
            Кликните на ячейку для просмотра деталей взаимодействия. Тепловая карта включена по умолчанию.
        </span>
    </div>
    
    <!-- Секция графиков -->
    <div class="charts-section" id="chartsSection">
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Распределение по ОПФ</h3>
                <canvas id="legalFormsChart" width="300" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h3>Интенсивность взаимодействий</h3>
                <canvas id="interactionHeatmapChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Блок Фильтров -->
     <div id="filtersContainer">
         <fieldset class="filter-group">
             <legend>Орг. форма:</legend>
             <label><input type="checkbox" class="filter-checkbox" name="legalForm" value="ALL" checked> Все</label>
             {% for form in legal_forms %}
             <label><input type="checkbox" class="filter-checkbox" name="legalForm" value="{{ form }}"> {{ form }}</label>
             {% endfor %}
         </fieldset>
         <fieldset class="filter-group">
             <legend>Тип операций:</legend>
             <label><input type="checkbox" class="filter-checkbox" name="hasIncome" value="1" checked> Был приход</label>
             <label><input type="checkbox" class="filter-checkbox" name="hasExpense" value="1" checked> Был расход</label>
         </fieldset>
         <fieldset class="filter-group">
             <legend>Работал только с:</legend>
             <label><input type="radio" class="filter-radio" name="onlyWithOrg" value="" checked> Не важно</label>
             {% for org_name in our_org_names %}
             <label><input type="radio" class="filter-radio" name="onlyWithOrg" value="{{ org_name | e }}"> Только {{ org_name }}</label>
             {% endfor %}
         </fieldset>
     </div>

    {% if not comparison_data %}
         <p>Нет данных о взаимодействии.</p>
    {% else %}
        <div id="comparisonTable_wrapper" class="dataTables_wrapper no-footer">
            <table id="comparisonTable" class="display compact" style="width:100%">
                <thead>
                    <tr>
                        <th>Контрагент</th>
                        {% for org_name in our_org_names %}
                        <th>{{ org_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {# Цикл генерации строк таблицы #}
                    {% for cp_id, cp_entry in comparison_data.items() %}
                        {% set details = cp_entry.details %}
                        {% set cp_norm_name = details.name_normalized %}
                        {% set cp_legal_form = details.legal_form %}
                        {% set cp_inn = details.inn %}
                        {% set cp_accs = details.accounts_str %}
                        {% set cp_raw_names = details.raw_names_str %}
                        {% if details.display_name %}
                            {% set display_name = details.display_name %}
                            {% if cp_legal_form == 'ИП' %} {% set display_name = 'ИП ' + display_name %} {% endif %}
                        {% else %}
                            {% set display_name = cp_norm_name %}
                            {% if cp_legal_form == 'ИП' %} {% set display_name = 'ИП ' + format_fio_display(cp_norm_name) %}
                            {% elif cp_legal_form == 'ООО' %} {% set display_name = 'ООО "' + cp_norm_name + '"' %}
                            {% elif cp_legal_form == 'АО' %} {% set display_name = 'АО "' + cp_norm_name + '"' %}
                            {% elif cp_legal_form == 'ГОС' %} {% set display_name = cp_norm_name %}
                            {% elif cp_legal_form == 'ФЛ' or cp_legal_form == 'ИП/ФЛ' %} {% set display_name = format_fio_display(cp_norm_name) %}
                            {% elif cp_norm_name != "?" and cp_legal_form not in ['ДРУГОЕ', 'ЮЛ'] %}
                                {% set is_likely_fio = '.' in cp_norm_name or cp_norm_name.count(' ') >= 1 %}
                                {% if is_likely_fio %}
                                    {% set display_name = cp_legal_form + ' ' + cp_norm_name %}
                                {% else %}
                                    {% set display_name = cp_legal_form + ' "' + cp_norm_name + '"' %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        {% set has_income_flag = 'true' if details.has_income else 'false' %}
                        {% set has_expense_flag = 'true' if details.has_expense else 'false' %}
                        {% set interacted_orgs_str = details.interacted_orgs | sort | join(',') %}

                        <tr data-legal-form="{{ cp_legal_form | e }}"
                            data-has-income="{{ has_income_flag }}"
                            data-has-expense="{{ has_expense_flag }}"
                            data-interacted-orgs="{{ interacted_orgs_str | e }}">
                            <td>
                                <span class="cp-name-display" title="{{ cp_raw_names | e }}">{{ display_name | safe }}</span>
                                <span class="cp-details-small">({% if cp_inn %}ИНН: {{ cp_inn | e }}{% else %}<span class="no-data">(не указ.)</span>{% endif %}{% if cp_accs %}, Счета: {{ cp_accs | e }}{% endif %})</span>
                            </td>
                            {% for org_name in our_org_names %}
                                {% set interaction = cp_entry.interactions.get(org_name) %}
                                {% set cell_content = '–' %}{% set cell_class = '' %}{% set title_text = org_name + ': Нет операций' %}
                                {% if interaction %}
                                    {% set types = interaction.types %}
                                    {% set tooltip_lines = [org_name + ':'] %}
                                    {% if 'income' in types %} {% set _ = tooltip_lines.append('  Приход: ' + interaction.income_count|string + ' шт, ' + format_currency(interaction.income_sum) + ' руб.') %} {% endif %}
                                    {% if 'expense' in types %} {% set _ = tooltip_lines.append('  Расход: ' + interaction.expense_count|string + ' шт, ' + format_currency(interaction.expense_sum) + ' руб.') %} {% endif %}
                                    {% set title_text = tooltip_lines | join('\n') %}
                                    {% set cell_class = "interaction-cell" %}
                                    {% if 'income' in types and 'expense' in types %} {% set cell_content = '↕' %}{% set cell_class = cell_class + " both" %}
                                    {% elif 'income' in types %} {% set cell_content = '↓' %}{% set cell_class = cell_class + " income" %}
                                    {% elif 'expense' in types %} {% set cell_content = '↑' %}{% set cell_class = cell_class + " expense" %}
                                    {% endif %}
                                {% endif %}
                                <td class="{{ cell_class }}" title="{{ title_text | e }}">{{ cell_content }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="legend">
            <strong>Обозначения (наведите на иконку для деталей):</strong><br>
            <span class="income interaction-cell">↓</span> - Только приход. <span class="expense interaction-cell">↑</span> - Только расход.
            <span class="both interaction-cell">↕</span> - Приход и расход. <span>–</span> - Нет операций.
        </div>
    {% endif %}
</main>

<!-- Модальное окно для детализации -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Детали взаимодействия</h2>
            <span class="close" id="closeModal">&times;</span>
        </div>
        <div class="modal-stats" id="modalStats">
            <!-- Статистика будет добавлена через JavaScript -->
        </div>
        <div id="modalContent">
            <!-- Содержимое будет добавлено через JavaScript -->
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    // Форматтер валюты
    function formatCurrency(amount) { if (amount == null || isNaN(amount)) return '0,00'; return amount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    // Встроенная русская локализация
    var russianLocalization = { "processing": "Подождите...", "search": "Поиск:", "lengthMenu": "Показать _MENU_ записей", "info": "Записи с _START_ до _END_ из _TOTAL_ записей", "infoEmpty": "Записи с 0 до 0 из 0 записей", "infoFiltered": "(отфильтровано из _MAX_ записей)", "loadingRecords": "Загрузка записей...", "zeroRecords": "Записи отсутствуют.", "emptyTable": "В таблице отсутствуют данные", "paginate": { "first": "Первая", "previous": "Предыдущая", "next": "Следующая", "last": "Последняя" }, "aria": { "sortAscending": ": акт. для сорт. по возрастанию", "sortDescending": ": акт. для сорт. по убыванию" }, "select": { "rows": { "_": "Выбрано: %d", "0": "", "1": "Выбрана 1 запись" } } };
    
    // Переменные для тепловой карты
    var heatmapEnabled = true; // Включена по умолчанию
    var maxAmount = 0;
    var minAmount = 0;
    
    // Переменные для графиков
    var legalFormsChart = null;
    var interactionHeatmapChart = null;
    
    // Создание круговой диаграммы по ОПФ
    function createLegalFormsChart() {
        const ctx = document.getElementById('legalFormsChart').getContext('2d');
        
        const legalFormsData = {};
        $('#comparisonTable tbody tr').each(function() {
            const form = $(this).attr('data-legal-form') || 'ДРУГОЕ';
            if (!legalFormsData[form]) {
                legalFormsData[form] = 0;
            }
            legalFormsData[form]++;
        });
        
        const labels = Object.keys(legalFormsData);
        const data = Object.values(legalFormsData);
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
        ];
        
        if (legalFormsChart) {
            legalFormsChart.destroy();
        }
        
        legalFormsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }
    
    // Создание графика интенсивности взаимодействий
    function createInteractionHeatmapChart() {
        const ctx = document.getElementById('interactionHeatmapChart').getContext('2d');
        
        const orgNames = [];
        const interactionData = [];
        
        // Собираем данные по организациям
        $('#comparisonTable thead th').each(function(index) {
            if (index > 0) { // Пропускаем первую колонку (контрагенты)
                orgNames.push($(this).text());
            }
        });
        
        // Считаем общее количество взаимодействий для каждой организации
        orgNames.forEach((orgName, orgIndex) => {
            let totalInteractions = 0;
            $('#comparisonTable tbody tr').each(function() {
                const cell = $(this).find('td').eq(orgIndex + 1);
                const title = cell.attr('title');
                if (title && title !== `${orgName}: Нет операций`) {
                    // Парсим количество операций из title
                    const match = title.match(/(\d+)\s*шт/g);
                    if (match) {
                        match.forEach(m => {
                            const count = parseInt(m.match(/\d+/)[0]);
                            totalInteractions += count;
                        });
                    }
                }
            });
            interactionData.push(totalInteractions);
        });
        
        if (interactionHeatmapChart) {
            interactionHeatmapChart.destroy();
        }
        
        interactionHeatmapChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: orgNames,
                datasets: [{
                    label: 'Количество операций',
                    data: interactionData,
                    backgroundColor: '#4BC0C0',
                    borderColor: '#4BC0C0',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Сохранение состояния фильтров
    function saveFilterState() {
        const state = {
            legalForms: [],
            hasIncome: $('input[name="hasIncome"]').is(':checked'),
            hasExpense: $('input[name="hasExpense"]').is(':checked'),
            onlyWithOrg: $('input[name="onlyWithOrg"]:checked').val()
        };
        
        $('input[name="legalForm"]:checked').each(function() {
            state.legalForms.push($(this).val());
        });
        
        localStorage.setItem('comparisonReportFilters', JSON.stringify(state));
    }
    
    function loadFilterState() {
        const saved = localStorage.getItem('comparisonReportFilters');
        if (saved) {
            try {
                const state = JSON.parse(saved);
                
                // Восстанавливаем чекбоксы ОПФ
                $('input[name="legalForm"]').prop('checked', false);
                state.legalForms.forEach(function(form) {
                    $(`input[name="legalForm"][value="${form}"]`).prop('checked', true);
                });
                
                // Восстанавливаем остальные фильтры
                $('input[name="hasIncome"]').prop('checked', state.hasIncome);
                $('input[name="hasExpense"]').prop('checked', state.hasExpense);
                $(`input[name="onlyWithOrg"][value="${state.onlyWithOrg}"]`).prop('checked', true);
                
            } catch (e) {
                console.warn('Ошибка загрузки состояния фильтров:', e);
            }
        }
    }
    
    // Функция для показа модального окна
    function showDetailModal(cpName, orgName, interaction) {
        $('#modalTitle').text(`Взаимодействие: ${cpName} ↔ ${orgName}`);
        
        // Статистика
        let statsHtml = '';
        if (interaction) {
            let totalAmount = (interaction.income_sum || 0) + (interaction.expense_sum || 0);
            let totalCount = (interaction.income_count || 0) + (interaction.expense_count || 0);
            
            statsHtml = `
                <div class="modal-stat">
                    <div class="modal-stat-value income">${formatCurrency(interaction.income_sum || 0)}</div>
                    <div class="modal-stat-label">Приход</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value expense">${formatCurrency(interaction.expense_sum || 0)}</div>
                    <div class="modal-stat-label">Расход</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${formatCurrency(totalAmount)}</div>
                    <div class="modal-stat-label">Общая сумма</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${totalCount}</div>
                    <div class="modal-stat-label">Операций</div>
                </div>
            `;
        } else {
            statsHtml = '<div class="modal-stat"><div class="modal-stat-value">Нет данных</div><div class="modal-stat-label">Взаимодействие отсутствует</div></div>';
        }
        $('#modalStats').html(statsHtml);
        
        // Детальная таблица (пока упрощенная)
        let contentHtml = '<p>Детальная информация о взаимодействии будет добавлена в следующих версиях.</p>';
        $('#modalContent').html(contentHtml);
        
        $('#detailModal').show();
    }
    
    // Функция для расчета тепловой карты
    function calculateHeatmap() {
        if (!heatmapEnabled) return;
        
        let amounts = [];
        $('#comparisonTable tbody tr').each(function() {
            $(this).find('td.interaction-cell').each(function() {
                let title = $(this).attr('title');
                if (title && title.includes('руб.')) {
                    let match = title.match(/(\d+(?:[.,]\d+)*)/g);
                    if (match) {
                        match.forEach(function(amountStr) {
                            let amount = parseFloat(amountStr.replace(',', '.'));
                            if (!isNaN(amount)) amounts.push(amount);
                        });
                    }
                }
            });
        });
        
        if (amounts.length > 0) {
            maxAmount = Math.max(...amounts);
            minAmount = Math.min(...amounts);
        }
    }
    
    // Функция для применения тепловой карты
    function applyHeatmap() {
        if (!heatmapEnabled) {
            $('#comparisonTable tbody tr').each(function() {
                $(this).find('td.interaction-cell').removeClass('heatmap-low heatmap-medium heatmap-high heatmap-very-high');
            });
            return;
        }
        
        $('#comparisonTable tbody tr').each(function() {
            $(this).find('td.interaction-cell').each(function() {
                let title = $(this).attr('title');
                if (title && title.includes('руб.')) {
                    let match = title.match(/(\d+(?:[.,]\d+)*)/g);
                    if (match) {
                        let maxAmountInCell = 0;
                        match.forEach(function(amountStr) {
                            let amount = parseFloat(amountStr.replace(',', '.'));
                            if (!isNaN(amount) && amount > maxAmountInCell) {
                                maxAmountInCell = amount;
                            }
                        });
                        
                        if (maxAmountInCell > 0) {
                            let ratio = (maxAmountInCell - minAmount) / (maxAmount - minAmount);
                            $(this).removeClass('heatmap-low heatmap-medium heatmap-high heatmap-very-high');
                            
                            if (ratio < 0.25) $(this).addClass('heatmap-low');
                            else if (ratio < 0.5) $(this).addClass('heatmap-medium');
                            else if (ratio < 0.75) $(this).addClass('heatmap-high');
                            else $(this).addClass('heatmap-very-high');
                        }
                    }
                }
            });
        });
    }

    $(document).ready(function() {
        // Инициализация состояния
        loadFilterState();
        
        try {
            var table = $('#comparisonTable').DataTable({
                "language": russianLocalization,
                "paging": false,
                "info": true,
                "order": [[0, 'asc']],
                "searching": true,
                "columnDefs": [ { "orderable": false, "targets": "_all" }, { "orderable": true, "targets": 0 } ],
                "stateSave": false, // Сохранение состояния отключено
                "stateDuration": 0
            });

            var allRowNodes = table.rows().nodes().toArray();
            var legalFormsInTable = [...new Set(allRowNodes.map(node => $(node).attr('data-legal-form')))].filter(Boolean);
            var legalFormsFromTemplate = [];
             $('input[name="legalForm"]:not([value=ALL])').each(function(){ legalFormsFromTemplate.push($(this).val()); });
             legalFormsFromTemplate.forEach(form => { if (!legalFormsInTable.includes(form)) { legalFormsInTable.push(form); } });
             legalFormsInTable.sort();

            // Инициализация объекта фильтров
            var filters = { legalForm: [...legalFormsInTable], hasIncome: true, hasExpense: true, onlyWithOrg: '' };
            // Установка начального состояния чекбоксов
            $('input[name="legalForm"]').prop('checked', true);
            $('input[name="hasIncome"]').prop('checked', true);
            $('input[name="hasExpense"]').prop('checked', true);
            $('input[name="onlyWithOrg"][value=""]').prop('checked', true);

            // Функция применения фильтров
            function applyFilters() {
                // Сбор состояния чекбоксов ОПФ
                let selectedFormsCheckboxes = [];
                $('input[name="legalForm"]:checked').each(function() { selectedFormsCheckboxes.push($(this).val()); });

                // Обновление фильтра ОПФ
                if (selectedFormsCheckboxes.includes('ALL') || selectedFormsCheckboxes.length === 0) {
                    filters.legalForm = [...legalFormsInTable]; // Все формы
                    if (selectedFormsCheckboxes.length === 0) $('input[name="legalForm"][value="ALL"]').prop('checked', true);
                    if (selectedFormsCheckboxes.includes('ALL')) $('input[name="legalForm"]').prop('checked', true);
                } else {
                    filters.legalForm = selectedFormsCheckboxes; // Только выбранные
                    $('input[name="legalForm"][value="ALL"]').prop('checked', false);
                }

                // Обновление остальных фильтров
                filters.hasIncome = $('input[name="hasIncome"]').is(':checked');
                filters.hasExpense = $('input[name="hasExpense"]').is(':checked');
                filters.onlyWithOrg = $('input[name="onlyWithOrg"]:checked').val();

                // Перерисовка таблицы
                table.draw();
            }

            // Обработчики изменения фильтров
            $('input[name="legalForm"]').on('change', function() {
                 var isChecked = $(this).is(':checked'); var value = $(this).val();
                 if (value === 'ALL') { $('input[name="legalForm"]').prop('checked', isChecked); }
                 else {
                     if (isChecked) { $('input[name="legalForm"][value="ALL"]').prop('checked', false); }
                     else { if ($('input[name="legalForm"]:checked:not([value=ALL])').length === 0) { $('input[name="legalForm"][value="ALL"]').prop('checked', true); } }
                 }
                 applyFilters();
                 saveFilterState();
            });
            $('input[name="hasIncome"], input[name="hasExpense"], input[name="onlyWithOrg"]').on('change', function() {
                applyFilters();
                saveFilterState();
            });

            // Кастомная функция фильтрации DataTables
            $.fn.dataTable.ext.search.push( function( settings, data, dataIndex ) {
                if (settings.nTable.id !== 'comparisonTable') return true;
                var node = table.row(dataIndex).node();
                if (!node) return false;

                try {
                    var rowLegalForm = String($(node).attr('data-legal-form') || '');
                    var rowHasIncome = $(node).attr('data-has-income') === 'true';
                    var rowHasExpense = $(node).attr('data-has-expense') === 'true';
                    var rowOrgs = ($(node).attr('data-interacted-orgs') || '').toString().split(',').filter(Boolean);

                    // 1. Проверка ОПФ
                    let formFilterPassed = false;
                    const mainForms = ['ИП', 'ООО', 'АО', 'ГОС', 'ФЛ'];
                    let isOtherForm = rowLegalForm && !mainForms.includes(rowLegalForm);
                    if (filters.legalForm.includes(rowLegalForm) || (filters.legalForm.includes('ДРУГОЕ') && isOtherForm)) {
                        formFilterPassed = true;
                    }
                    if (!formFilterPassed) return false;

                    // 2. Проверка Типа Операций
                    let typeFilterPassed = false;
                    if (filters.hasIncome && filters.hasExpense) { typeFilterPassed = rowHasIncome || rowHasExpense; }
                    else if (filters.hasIncome) { typeFilterPassed = rowHasIncome; }
                    else if (filters.hasExpense) { typeFilterPassed = rowHasExpense; }
                    else { typeFilterPassed = false; } // Если оба выключены - не показываем
                    if (!typeFilterPassed) return false;

                    // 3. Проверка "Только С"
                    if (filters.onlyWithOrg && (rowOrgs.length !== 1 || rowOrgs[0] !== filters.onlyWithOrg)) {
                        return false;
                    }

                    return true; // Показать строку, если все проверки пройдены

                } catch (e) {
                    // В production коде можно убрать console.error или заменить на более мягкое сообщение
                    console.error(`Ошибка в кастомном фильтре для строки ${dataIndex}:`, e);
                    return false; // Лучше скрыть строку, чем сломать интерфейс
                }
            });

            // Первоначальное применение фильтров (покажет все строки)
            applyFilters();
            
            // Обработчики для модального окна
            $('#closeModal').on('click', function() {
                $('#detailModal').hide();
            });
            
            $(window).on('click', function(event) {
                if (event.target.id === 'detailModal') {
                    $('#detailModal').hide();
                }
            });
            
            // Обработчик клика по ячейкам взаимодействия
            $('#comparisonTable tbody').on('click', 'td.interaction-cell', function() {
                let row = $(this).closest('tr');
                let cpName = row.find('td:first-child .cp-name-display').text();
                let orgName = $(this).closest('table').find('thead th').eq($(this).index()).text();
                let title = $(this).attr('title');
                
                // Парсим данные из title для упрощенного отображения
                let interaction = null;
                if (title && title !== `${orgName}: Нет операций`) {
                    interaction = {
                        income_sum: 0,
                        expense_sum: 0,
                        income_count: 0,
                        expense_count: 0
                    };
                    
                    // Простой парсинг из title
                    if (title.includes('Приход:')) {
                        let incomeMatch = title.match(/Приход:\s*(\d+)\s*шт,\s*([\d\s,]+)\s*руб/);
                        if (incomeMatch) {
                            interaction.income_count = parseInt(incomeMatch[1]);
                            interaction.income_sum = parseFloat(incomeMatch[2].replace(/\s/g, '').replace(',', '.'));
                        }
                    }
                    
                    if (title.includes('Расход:')) {
                        let expenseMatch = title.match(/Расход:\s*(\d+)\s*шт,\s*([\d\s,]+)\s*руб/);
                        if (expenseMatch) {
                            interaction.expense_count = parseInt(expenseMatch[1]);
                            interaction.expense_sum = parseFloat(expenseMatch[2].replace(/\s/g, '').replace(',', '.'));
                        }
                    }
                }
                
                showDetailModal(cpName, orgName, interaction);
            });
            
            // Инициализируем тепловую карту сразу
            calculateHeatmap();
            applyHeatmap();
            
            // Инициализируем графики
            createLegalFormsChart();
            createInteractionHeatmapChart();
            
            // Применяем тепловую карту при изменении фильтров
            table.on('draw', function() {
                if (heatmapEnabled) {
                    calculateHeatmap();
                    applyHeatmap();
                }
                // Обновляем графики
                createLegalFormsChart();
                createInteractionHeatmapChart();
            });

        } catch (e) {
             console.error("Ошибка при инициализации DataTables:", e);
             alert("Ошибка при инициализации таблицы данных. Проверьте консоль разработчика (F12) для деталей.");
        }
    });
</script>
</body>
</html>