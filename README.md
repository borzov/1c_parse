# Анализатор выписок 1С

Этот инструмент предназначен для автоматического анализа банковских выписок в формате 1С (стандарт `1CClientBankExchange`, файлы `.txt`). Он обрабатывает файлы из папки `data`, самостоятельно определяет ваши организации и контрагентов, нормализует их имена, агрегирует финансовые потоки и генерирует два интерактивных HTML-отчета для удобного просмотра данных.

## Предназначение

Часто при работе с несколькими юридическими лицами или счетами возникает необходимость анализировать финансовые операции, выгруженные из разных банк-клиентов. Стандартный формат 1С удобен для обмена, но ручной анализ множества таких файлов сложен из-за их объема и возможных небольших различий в данных.

Данный скрипт автоматизирует этот процесс, предоставляя сводную информацию в наглядном виде. Он берет на себя рутинные задачи: чтение файлов, идентификацию участников операций, очистку и стандартизацию имен, расчет итоговых сумм и представление результатов в виде интерактивных веб-страниц.

## Основные возможности

Скрипт автоматически обрабатывает все `.txt` файлы, найденные в папке `data`. Он корректно разбирает структуру файлов `1CClientBankExchange`, извлекая информацию о счетах и документах (транзакциях), и учитывает возможные вариации полей (например, `Плательщик` и `Плательщик1`). Важной особенностью является автоопределение ваших организаций: скрипт сам определяет, какие счета в выписках принадлежат вам, и находит наиболее полные наименования из доступных данных, избавляя от необходимости ручной настройки списка счетов.

Имена контрагентов проходят продвинутую нормализацию: они приводятся к единому формату с автоматическим определением организационно-правовой формы (ИП, ООО, АО, ГОС, ФЛ и другие). Из названий удаляются ОПФ, кавычки, банковские реквизиты, фрагменты адресов и прочий "мусор". ФИО для ИП и физлиц форматируются как "Фамилия И.О.". Приоритетным идентификатором контрагента является ИНН; при его отсутствии используется комбинация нормализованного имени и счета.

Для удобства анализа в папке `reports` создаются два интерактивных HTML-отчета с использованием JavaScript-библиотеки DataTables. Годовой отчет по контрагентам показывает итоговые суммы прихода и расхода, позволяя раскрывать строки для детализации по годам и организациям. Сравнительный отчет представляет матрицу "Контрагент <-> Ваша организация" с иконками, показывающими характер взаимодействия (приход, расход, оба, нет операций), и всплывающими подсказками с суммами. Оба отчета поддерживают поиск, сортировку и имеют настраиваемые фильтры (по ОПФ, типу операций, взаимодействию только с одной организацией). Пагинация в отчетах отключена для удобства просмотра всех данных.

При включенном режиме отладки (`DEBUG_MODE = True` в `src/config.py`) генерируются дополнительные файлы в папке `reports`: `analysis.txt` (подробный лог работы), `debug_names.csv` (результаты нормализации имен для проверки и доработки алгоритма) и `debug_processed_transactions.csv` (список всех обработанных транзакций).

## Требования

*   Python 3.9 или новее
*   Библиотека Jinja2

## Установка

1.  Скачайте или клонируйте репозиторий проекта.
2.  Перейдите в папку проекта.
3.  Рекомендуется создать и активировать виртуальное окружение:
    ```bash
    python3 -m venv venv
    # Активация:
    # source venv/bin/activate  (macOS/Linux)
    # venv\Scripts\activate   (Windows CMD)
    # venv\Scripts\Activate.ps1 (Windows PowerShell)
    ```
4.  Установите зависимости:
    ```bash
    pip install Jinja2
    ```
5.  Убедитесь, что папка `templates` существует и содержит файлы `report_annual_template.html` и `report_comparison_template.html`.
6.  Создайте папку `data` и поместите в нее ваши `.txt` файлы выписок.
7.  (Опционально) Проверьте кодировку файлов выписок и при необходимости измените значение `FILE_ENCODING` в файле `src/config.py` (по умолчанию 'cp1251').

## Использование

1.  Активируйте виртуальное окружение (если используете).
2.  Запустите анализ из **корневой папки проекта**:
    ```bash
    python -m src
    ```
    *(Используйте `python` или `python3` в зависимости от вашей системы)*
3.  Дождитесь завершения скрипта.
4.  Результаты анализа будут доступны в виде HTML-файлов в папке `reports`. Откройте их в вашем веб-браузере.
5.  При необходимости включите `DEBUG_MODE = True` в `src/config.py` для получения отладочных файлов (`analysis.txt`, `debug_names.csv`, `debug_processed_transactions.csv`) в папке `reports`.

## Алгоритм Работы

Процесс анализа включает несколько ключевых шагов. Сначала происходит чтение всех `.txt` файлов из папки `data`. Каждый файл разбирается согласно формату `1CClientBankExchange` для извлечения информации о файле (заголовок) и содержащихся в нем транзакциях (документы), при этом определяется основной счет файла выписки.

Затем скрипт автоматически идентифицирует счета, принадлежащие вашим организациям. Он анализирует информацию из заголовков и документов всех файлов, находя наиболее полные наименования для каждого вашего счета и определяя его ОПФ и ИНН.

На этапе обработки транзакций каждый документ анализируется для определения типа операции (приход/расход) относительно счета файла выписки, идентификации вашей организации и контрагента. Внутренние переводы между вашими счетами пропускаются. Имя контрагента нормализуется: удаляется мусор, определяется ОПФ, форматируются ФИО. После этого формируется уникальный идентификатор контрагента (на основе ИНН или имени и счета) и создается общий список обработанных транзакций.

В завершение, на основе списка обработанных транзакций и информации о ваших организациях, генерируются два набора данных для отчетов. Для годового отчета данные агрегируются по контрагентам, затем по годам и вашим организациям. Для отчета о взаимодействии агрегация происходит по контрагентам и вашим организациям с подсчетом сумм и количества приходов/расходов для каждой пары. Эти подготовленные данные передаются в соответствующие HTML-шаблоны с помощью Jinja2, и готовые HTML-страницы с интерактивными таблицами сохраняются в папку `reports`.